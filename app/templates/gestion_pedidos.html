{% extends "plantillaapp.html" %}
{% block titulo %}Gestión de Pedidos{% endblock %}

{% block LinkAdicional %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/gestionpedidos.css') }}">
{% endblock %}

{% block body %}
<div class="container-pedidos">
    <h2 class="titulo-seccion">Administración de Pedidos</h2>

    <!-- Filtros -->
    <div class="filtros-container">
        <div class="filtro-item search-wrapper">
            <i class="fas fa-search search-icon"></i>
            <input type="text" id="busquedaInput" class="filtro-input" placeholder="Buscar Referencia, Nombre...">
        </div>
        <div class="filtro-item">
            <select id="estadoFilter" class="filtro-input">
                <option value="TODOS">Todos los Estados</option>
                <option value="APROBADO">✅ Aprobados</option>
                <option value="PENDIENTE">⏳ Pendientes</option>
                <option value="RECHAZADO">❌ Rechazados</option>
            </select>
        </div>
    </div>

    <!-- Tabla -->
    <div class="tabla-wrapper">
        <table id="tablaPedidos">
            <thead>
                <tr>
                    <th>Referencia</th>
                    <th>Cliente</th>
                    <th>Total</th>
                    <th>Estado</th>
                    <th>Envío</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% if pedidos %}
                {% for p in pedidos %}
                <tr class="pedido-row" data-estado="{{ p['estado_pago'] }}">

                    <!-- REF (Incluye el ID de PayU) -->
                    <td data-label="Referencia">
                        <strong class="ref-texto">{{ p['referencia_pedido'] }}</strong>
                        <div style="margin-top:5px; font-size:0.9em; color:#666;">
                            <i class="far fa-clock"></i> {{ p['fecha_creacion'].strftime('%Y-%m-%d') }}
                        </div>
                        <!-- AQUI ESTÁ LA CORRECCIÓN: -->
                        <div style="margin-top:2px; font-size:0.85em; color:#888;">
                            ID: <strong>{{ p['id_transaccion_payu'] if p['id_transaccion_payu'] else '---' }}</strong>
                        </div>
                    </td>

                    <!-- Cliente -->
                    <td data-label="Cliente">
                        <div class="contenido-celda">
                            <strong style="color:#333;">{{ p['cliente_nombre'] }}</strong>
                            <div class="dato-secundario">{{ p['cliente_documento'] }}</div>
                        </div>
                    </td>

                    <!-- Total -->
                    <td data-label="Total">
                        <strong style="color:#0d1b54; font-size:1.2em;">${{ "{:,.0f}".format(p['monto_total'])
                            }}</strong>
                    </td>

                    <!-- Estado -->
                    <td data-label="Estado">
                        <div style="text-align: right;">
                            {% if p['estado_pago'] == 'APROBADO' %}
                            <span class="badge bg-aprobado">Aprobado</span>
                            {% elif p['estado_pago'] == 'RECHAZADO' %}
                            <span class="badge bg-rechazado">Rechazado</span>
                            {% else %}
                            <span class="badge bg-pendiente">{{ p['estado_pago'] }}</span>
                            {% endif %}
                            <div class="dato-secundario" style="margin-top:5px;">{{ p['metodo_pago'] or '---' }}</div>
                        </div>
                    </td>

                    <!-- Envío -->
                    <td data-label="Envío">
                        {{ p['estado_envio'] }}
                    </td>

                    <!-- Acciones -->
                    <td data-label="Acciones">
                        <button class="btn-icon btn-view" onclick="abrirModal(
                                '{{ p['referencia_pedido'] }}', 
                                '{{ p['detalles_compra']|safe }}', 
                                '{{ p['direccion_envio'] }}',
                                '{{ p['ciudad'] }}',
                                '{{ p['cliente_telefono'] }}'
                            )"><i class="fas fa-eye"></i></button>

                        <a href="https://wa.me/57{{ p['cliente_telefono'] }}" target="_blank" class="btn-icon btn-wa">
                            <i class="fab fa-whatsapp"></i>
                        </a>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="6" style="text-align:center; padding:30px;">No hay pedidos.</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal -->
<div id="modalDetalle" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <span class="modal-title">Detalle del Pedido</span>
            <button class="close-btn" onclick="cerrarModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p><strong>Ref:</strong> <span id="modalRef" style="color:#0d1b54; word-break:break-all;"></span></p>
            <hr style="margin:15px 0; border:0; border-top:1px dashed #eee;">
            <h4 style="margin-bottom:10px;">Productos:</h4>
            <ul id="modalListaProductos" style="padding-left:20px; margin-bottom:20px;"></ul>
            <div style="background:#f8f9fa; padding:15px; border-radius:8px;">
                <p><strong>Dirección:</strong> <span id="modalDireccion"></span></p>
                <p><strong>Ciudad:</strong> <span id="modalCiudad"></span></p>
                <p><strong>Teléfono:</strong> <span id="modalTelefono"></span></p>
            </div>
            <button onclick="cerrarModal()"
                style="width:100%; padding:12px; background:#0d1b54; color:white; border:none; border-radius:8px; margin-top:20px; font-weight:bold;">Cerrar</button>
        </div>
    </div>
</div>

<script>
    const modal = document.getElementById('modalDetalle');
    const els = { ref: document.getElementById('modalRef'), lista: document.getElementById('modalListaProductos'), dir: document.getElementById('modalDireccion'), ciu: document.getElementById('modalCiudad'), tel: document.getElementById('modalTelefono') };

    function abrirModal(ref, prod, dir, ciu, tel) {
        els.ref.textContent = ref;
        els.lista.innerHTML = prod || "<li>Sin datos</li>";
        els.dir.textContent = dir; els.ciu.textContent = ciu; els.tel.textContent = tel;
        modal.style.display = 'flex';
    }
    function cerrarModal() { modal.style.display = 'none'; }
    window.onclick = (e) => { if (e.target == modal) cerrarModal(); }

    function filtrar() {
        const txt = document.getElementById('busquedaInput').value.toLowerCase();
        const est = document.getElementById('estadoFilter').value;

        document.querySelectorAll('.pedido-row').forEach(row => {
            const textoFila = row.innerText.toLowerCase();
            const estadoFila = row.getAttribute('data-estado');

            const cumpleTexto = textoFila.includes(txt);
            const cumpleEstado = (est === 'TODOS') || (estadoFila === est);

            if (cumpleTexto && cumpleEstado) {
                row.style.display = ''; // Usamos vacío para que el CSS (block en móvil, table-row en escritorio) funcione
            } else {
                row.style.setProperty('display', 'none', 'important'); // Forzamos ocultar
            }
        });
    }

    const input = document.getElementById('busquedaInput');
    input.addEventListener('keyup', filtrar);
    input.addEventListener('input', filtrar);
    document.getElementById('estadoFilter').addEventListener('change', filtrar);
</script>
{% endblock %}