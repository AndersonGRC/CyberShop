{% extends './plantillaindex.html' %}

{% block titulo %}Finalizar Compra - {{ datosApp.titulo }}{% endblock %}

{% block LinkAdicional %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pago.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock %}

{% block body %}
<div class="container">
    <h2 style="text-align: center; margin-top: 30px; margin-bottom: 20px; font-weight: 700; color: #333;">Finalizar Compra</h2>
    
    <div class="contenedor-pago">
        
        <div class="resumen-lateral">
            <h3 style="margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px;">Resumen del Pedido</h3>
            
            {% if carrito and carrito['items'] %}
                {% for item in carrito['items'] %}
                <div class="item-resumen">
                    <img src="{{ item.imagen }}" alt="{{ item.nombre }}">
                    <div style="flex: 1;">
                        <div style="font-weight: bold; font-size: 0.9em;">{{ item.nombre }}</div>
                        <div style="color: #777; font-size: 0.85em;">{{ item.cantidad }} x {{ item.precio }}</div>
                    </div>
                    <div style="font-weight: bold;">
                        {{ item.precio * item.cantidad }}
                    </div>
                </div>
                {% endfor %}
                <div class="total-resumen">
                    Total: {{ '%.2f' % carrito.total }} COP
                </div>
            {% else %}
                <p>Tu carrito está vacío.</p>
                <a href="{{ url_for('public.productos') }}" style="color: #a6c438;">Volver a la tienda</a>
            {% endif %}
        </div>

        <div class="seccion-formulario">
            
            <div id="paso-1" class="paso-activo">
                <h3 style="text-align: center; margin-bottom: 25px;">Selecciona tu método de pago</h3>
                
                <div class="metodo-opciones">
                    <div class="opcion-payu-card" id="seleccionar-pse">
                        <img src="{{ url_for('static', filename='img/PayU.png') }}" alt="Logo PayU Latam">
                        <p>Pagar en línea (Tarjetas, PSE, Efectivo)</p>
                    </div>
                </div>

                <div class="whatsapp-option">
                    <h3 style="font-size: 1.1em; color: #555;">¿Prefieres pagar en efectivo o transferir?</h3>
                    <a href="{{ whatsapp_url }}" 
                       target="_blank" 
                       id="whatsapp-link" 
                       class="whatsapp-pago">
                        <i class="fab fa-whatsapp" style="margin-right: 8px; font-size: 1.2em;"></i> Pagar por WhatsApp
                    </a>
                </div>
            </div>

            <div id="paso-2" class="paso-oculto">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Confirmar y Pagar</h3>
                    <button type="button" class="btn-volver" style="background: none; border: none; color: #666; cursor: pointer; text-decoration: underline; font-weight: 600;">
                        <i class="fas fa-arrow-left"></i> Volver
                    </button>
                </div>

                <form action="{{ url_for('payments.crear_orden') }}" method="POST">
                    
                    <div class="form-group">
                        <label class="form-label">Nombre completo</label>
                        <input type="text" name="buyerFullName" class="form-control" required placeholder="Ej: Juan Pérez">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Correo electrónico</label>
                        <input type="email" name="buyerEmail" class="form-control" required placeholder="Ej: juan@email.com">
                    </div>

                    <div class="fila-doble">
                        <div class="form-group" style="flex: 0.4;">
                            <label class="form-label">Tipo Doc.</label>
                            <select name="payerDocumentType" class="form-control" required>
                                <option value="CC">CC (Cédula)</option>
                                <option value="CE">CE (Extranjería)</option>
                                <option value="TI">TI (Tarjeta Identidad)</option>
                                <option value="NIT">NIT (Empresa)</option>
                                <option value="PP">Pasaporte</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 0.6;">
                            <label class="form-label">Documento de identidad</label>
                            <input type="text" name="payerDocument" class="form-control" required placeholder="Número sin puntos">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Teléfono de contacto</label>
                        <input type="text" name="buyerPhone" class="form-control" required placeholder="Ej: 3001234567">
                    </div>

                    <div class="fila-doble">
                        <div class="form-group">
                            <label class="form-label">Ciudad</label>
                            <input type="text" name="shippingCity" class="form-control" required placeholder="Ej: Bogotá">
                        </div>
                        <div class="form-group" style="flex: 1.5;">
                            <label class="form-label">Dirección de entrega</label>
                            <input type="text" name="shippingAddress" class="form-control" required placeholder="Ej: Calle 123 # 45-67 Apto 101">
                        </div>
                    </div>

                    <div style="margin-top: 25px;">
                        <button type="submit" class="btn-pagar">
                            Pagar ahora de forma segura <i class="fas fa-lock" style="margin-left: 5px;"></i>
                        </button>
                    </div>
                </form>
            </div>

        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const paso1 = document.getElementById("paso-1");
        const paso2 = document.getElementById("paso-2");
        const btnPse = document.getElementById("seleccionar-pse");
        const btnVolver = document.querySelector(".btn-volver");

        btnPse.addEventListener("click", function() {
            paso1.style.display = "none";
            paso2.style.display = "block";
            window.scrollTo({ top: 150, behavior: 'smooth' });
        });

        btnVolver.addEventListener("click", function() {
            paso2.style.display = "none";
            paso1.style.display = "block";
        });
    });
</script>
{% endblock %}